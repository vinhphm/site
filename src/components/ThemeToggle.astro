---
import CircleIcon from '~icons/ri/circle-fill'
---

<button type="button"
        aria-label="Toggle theme"
        class="text-gray-500 dark:text-zinc-500 hover:text-gray-900 dark:hover:text-zinc-100 cursor-pointer theme-toggle">
  <span class="sr-only">Toggle theme</span>
  <CircleIcon />
</button>

<script>
  function nextTick() {
    return Promise.resolve()
  }

  function getSystemTheme() {
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
  }

  function getCurrentStoredTheme() {
    return localStorage.getItem('color-scheme') || 'auto'
  }

  function getNextTheme(current) {
    const systemTheme = getSystemTheme()

    if (current === 'light') {
      return systemTheme === 'dark' ? 'auto' : 'dark'
    } else if (current === 'dark') {
      return systemTheme === 'light' ? 'auto' : 'light'
    } else {
      return systemTheme === 'light' ? 'dark' : 'light'
    }
  }

  function applyTheme(theme) {
    const actualTheme = theme === 'auto' ? getSystemTheme() : theme
    document.documentElement.setAttribute('data-theme', actualTheme)
    if (theme === 'auto') {
      setupSystemThemeListener()
    } else {
      cleanupSystemThemeListener()
    }
  }

  function toggleDark(event) {
    const startViewTransition = document.startViewTransition
    const isPrefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches
    const isAppearanceTransition = typeof startViewTransition === 'function' && !isPrefersReducedMotion

    if (!isAppearanceTransition) {
      const currentTheme = getCurrentStoredTheme()
      const newTheme = getNextTheme(currentTheme)

      applyTheme(newTheme)
      localStorage.setItem('color-scheme', newTheme)
      return
    }

    document.documentElement.classList.add('theme-transition')

    const x = event.clientX
    const y = event.clientY
    const endRadius = Math.hypot(Math.max(x, innerWidth - x), Math.max(y, innerHeight - y))

    const transition = document.startViewTransition(async () => {
      const currentTheme = getCurrentStoredTheme()
      const newTheme = getNextTheme(currentTheme)

      applyTheme(newTheme)
      localStorage.setItem('color-scheme', newTheme)
      await nextTick()
    })

    transition.ready.then(() => {
      const clipPath = [`circle(0px at ${x}px ${y}px)`, `circle(${endRadius}px at ${x}px ${y}px)`]
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark'

      document.documentElement.animate(
        {
          clipPath: isDark ? [...clipPath].reverse() : clipPath,
        },
        {
          duration: 400,
          easing: 'ease-out',
          pseudoElement: isDark
            ? '::view-transition-old(root)'
            : '::view-transition-new(root)',
        },
      )
    }).finally(() => {
      transition.finished.then(() => {
        document.documentElement.classList.remove('theme-transition')
      })
    })
  }

  let systemThemeMediaQuery = null

  function setupSystemThemeListener() {
    if (systemThemeMediaQuery) {
      return
    }
    systemThemeMediaQuery = window.matchMedia('(prefers-color-scheme: dark)')
    systemThemeMediaQuery.addEventListener('change', handleSystemThemeChange)
  }

  function cleanupSystemThemeListener() {
    if (systemThemeMediaQuery) {
      systemThemeMediaQuery.removeEventListener('change', handleSystemThemeChange)
      systemThemeMediaQuery = null
    }
  }

  function handleSystemThemeChange() {
    const currentTheme = getCurrentStoredTheme()
    if (currentTheme === 'auto') {
      applyTheme('auto')
    }
  }

  function switchTheme() {
    const buttons = document.querySelectorAll('.theme-toggle')
    buttons.forEach(button => {
      if (button && !button.hasAttribute('data-theme-listener')) {
        button.setAttribute('data-theme-listener', 'true')
        button.addEventListener('click', (event) => {
          toggleDark(event)
        })
      }
    })
  }

  if (getCurrentStoredTheme() === 'auto') {
    setupSystemThemeListener()
  }
  switchTheme()

  document.addEventListener('astro:after-swap', () => {
    if (getCurrentStoredTheme() === 'auto') {
      setupSystemThemeListener()
    } else {
      cleanupSystemThemeListener()
    }
    switchTheme()
  })
</script>
